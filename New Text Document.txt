SELECT
	p.id_product,
	p.product_name,
	pi.src,
	CASE
              		WHEN pt.product_tag_active = 'True' THEN STRING_AGG(t.tag_name, ',')
              		ELSE NULL
            	END AS tag_names,
            	pr.product_price,
            	dp.discount_price,
            	dp.discount_value,
            	dp.saved,
            	CONVERT(BIT, CASE WHEN wp.id_product IS NOT NULL THEN 1 ELSE 0 END) AS in_wishlist,
	b.brand_name,
	c.category_name
FROM products p
INNER JOIN  product_images pi ON p.id_product = pi.id_product
INNER JOIN cat_brands cb ON cb.id_cat_brand = p.id_cat_brand
INNER JION categories c ON cb.id_category = c.id_category
INNER JOIN brands b ON cb.id_brand = b.id_brand
LEFT JOIN (
	SELECT id_product, product_price
	FROM prices
	WHERE price_date_till IS NULL
		AND price_date_from <= '${currDate}'
) pr ON p.id_product = pr.id_product
OUTER APPLY(
	SELECT TOP 1 dp.discount_price, dp.discount_value, dp.saved
	FROM discount_prices dp
	INNER JOIN prices pr2 ON dp.id_price = pr2.id_price
	INNER JOIN discount_durations dd ON dp.id_discount_duration = dd.id_discount_duration
	WHERE pr2.id_product = p.id_product
		AND dd.discount_date_from <= '${currDate}'
		AND dd.discount_date_till > '${currDate}'
	ORDER BY dd.discount_date_from DESC
) dp
LEFT JOIN (
	SELECT pt1.*
	FROM products_tags pt1
	LEFT JOIN products_tags pt2 ON pt1.id_product = pt2.id_product
	AND pt1.product_tag_date_till < pt2.product_tag_date_till
	WHERE pt2.id_product IS NULL
) pt ON p.id_product = pt.id_product
LEFT JOIN tags t ON t.id_tag = pt.id_tag
LEFT JOIN wishlists_products wp ON p.id_product = wp.id_product
LEFT JOIN wishlists w ON wp.id_wishlist = w.id_wishlist AND w.id_user = '${userId}'
WHERE c.id_category = '${categoryId}'
GROUP BY
	p.id_product,
	p.product_name,       
            	pi.src,       
          	pt.product_tag_active,
            	pr.product_price,
            	dp.discount_price,
            	dp.discount_value,
            	dp.saved,
            	wp.id_product,
	b.brand_name,
	c.category_name